<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direkt Video İndirici</title>
    <style>
        :root {
            --primary-color: #1e40af;
            --accent-color: #3b82f6;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --warning-color: #f59e0b;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            text-align: center;
            padding: 30px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--primary-color);
        }
        
        button:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            color: #64748b;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.2s;
            width: auto;
        }
        
        .tab-button:hover {
            color: var(--accent-color);
        }
        
        .tab-button.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        #status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        #status.info {
            background-color: #e0f2fe;
            color: #075985;
            border-left: 4px solid #0284c7;
        }
        
        #status.success {
            background-color: #dcfce7;
            color: #166534;
            border-left: 4px solid var(--success-color);
        }
        
        #status.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }
        
        #status.warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }
        
        .video-info {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 6px;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .video-details h3 {
            margin: 0 0 5px;
            color: var(--dark-color);
        }
        
        .video-meta {
            color: #64748b;
            font-size: 14px;
        }
        
        .quality-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .quality-option {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .quality-option:hover {
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .quality-option h3 {
            margin: 0 0 5px;
            color: var(--dark-color);
        }
        
        .quality-option p {
            color: #64748b;
            font-size: 14px;
            margin: 0 0 15px;
        }
        
        .download-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background-color: var(--primary-color);
        }
        
        .hidden {
            display: none !important;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: right;
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Mobil uyumluluk */
        @media (max-width: 768px) {
            .video-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .thumbnail {
                width: 100%;
                height: auto;
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .quality-options {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Direkt Video İndirici</h1>
            <p>YouTube videolarını direkt olarak indirin</p>
        </div>
        
        <div class="card">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="youtube">YouTube</button>
                    <button class="tab-button" data-tab="vimeo">Vimeo</button>
                    <button class="tab-button" data-tab="settings">Ayarlar</button>
                </div>
                
                <div class="tab-content active" id="youtube-tab">
                    <h2>YouTube Video İndirme</h2>
                    <div>
                        <label for="yt-url">Video URL'si:</label>
                        <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">
                        <button id="yt-analyze-btn">Video Analiz Et</button>
                    </div>
                    
                    <div id="status" class="hidden"></div>
                    <div class="spinner" id="spinner"></div>
                    
                    <div id="video-info-container" class="hidden">
                        <div class="video-info">
                            <img class="thumbnail" id="thumbnail" src="" alt="Video önizleme">
                            <div class="video-details">
                                <h3 id="video-title"></h3>
                                <div class="video-meta" id="video-meta"></div>
                            </div>
                        </div>
                        
                        <h3>İndirme Seçenekleri</h3>
                        <div class="quality-options" id="quality-options"></div>
                        
                        <div class="progress-container" id="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text" id="progress-text">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="vimeo-tab">
                    <h2>Vimeo Video İndirme</h2>
                    <div>
                        <label for="vimeo-url">Vimeo Video URL'si:</label>
                        <input type="text" id="vimeo-url" placeholder="https://vimeo.com/..." autocomplete="off">
                        <button id="vimeo-analyze-btn">Video Analiz Et</button>
                    </div>
                    
                    <div id="vimeo-status" class="hidden"></div>
                    <div class="spinner" id="vimeo-spinner"></div>
                    
                    <div id="vimeo-info-container" class="hidden">
                        <div class="video-info">
                            <img class="thumbnail" id="vimeo-thumbnail" src="" alt="Video önizleme">
                            <div class="video-details">
                                <h3 id="vimeo-title"></h3>
                                <div class="video-meta" id="vimeo-meta"></div>
                            </div>
                        </div>
                        
                        <h3>İndirme Seçenekleri</h3>
                        <div class="quality-options" id="vimeo-quality-options"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="settings-tab">
                    <h2>Ayarlar</h2>
                    <div>
                        <label for="download-method">İndirme Yöntemi:</label>
                        <select id="download-method">
                            <option value="direct">Doğrudan İndirme</option>
                            <option value="blob">Blob İndirme (Büyük dosyalar için)</option>
                        </select>
                        
                        <label for="proxy-server">Proxy Sunucu:</label>
                        <select id="proxy-server">
                            <option value="none">Kullanma</option>
                            <option value="corsanywhere" selected>CORS Anywhere</option>
                            <option value="allorigins">AllOrigins</option>
                        </select>
                        
                        <label for="filename-template">Dosya Adı Şablonu:</label>
                        <input type="text" id="filename-template" value="{title}" placeholder="Örnek: {title}-{quality}">
                        <p style="font-size: 14px; color: #64748b;">Kullanılabilir değişkenler: {title}, {quality}, {date}</p>
                        
                        <button id="save-settings">Ayarları Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Nasıl Kullanılır?</h2>
            <ol>
                <li>Video platformunu seçin (YouTube, Vimeo)</li>
                <li>Video URL'sini ilgili alana yapıştırın</li>
                <li>"Video Analiz Et" butonuna tıklayın</li>
                <li>Görünen kalite seçeneklerinden birine tıklayarak indirmeyi başlatın</li>
            </ol>
            <p><strong>Not:</strong> Bu uygulama, tarayıcıda çalışan JavaScript teknolojisi kullanır ve videoları doğrudan cihazınıza indirir. Hiçbir sunucu veya üçüncü taraf servis kullanılmaz.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab işlevselliği
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Tüm tabları ve butonları temizle
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Aktif tabı ve butonu belirle
                    this.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
            
            // Ayarları yükle
            loadSettings();
            
            // Ayarları kaydetme
            document.getElementById('save-settings').addEventListener('click', function() {
                saveSettings();
                showStatus('Ayarlar kaydedildi', 'success');
            });
            
            // YouTube analiz
            document.getElementById('yt-analyze-btn').addEventListener('click', function() {
                analyzeYouTubeVideo();
            });
            
            // Vimeo analiz
            document.getElementById('vimeo-analyze-btn').addEventListener('click', function() {
                analyzeVimeoVideo();
            });
            
            // Enter tuşu işlevselliği
            document.getElementById('yt-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeYouTubeVideo();
                }
            });
            
            document.getElementById('vimeo-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeVimeoVideo();
                }
            });
            
            // ================== YouTube İşlevleri ==================
            
            function analyzeYouTubeVideo() {
                const videoUrl = document.getElementById('yt-url').value.trim();
                if (!videoUrl) {
                    showStatus('Lütfen bir YouTube URL\'si girin', 'error');
                    return;
                }
                
                const videoId = extractYouTubeId(videoUrl);
                if (!videoId) {
                    showStatus('Geçersiz YouTube URL\'si', 'error');
                    return;
                }
                
                // UI sıfırlama ve yükleme gösterme
                showStatus('Video analiz ediliyor...', 'info');
                document.getElementById('spinner').style.display = 'block';
                document.getElementById('video-info-container').classList.add('hidden');
                document.getElementById('yt-analyze-btn').disabled = true;
                
                // İki farklı API ile deneyelim
                fetchYouTubeInfo(videoId)
                    .then(data => {
                        displayYouTubeInfo(data, videoId);
                    })
                    .catch(error => {
                        console.error('Birinci API hatası:', error);
                        
                        // İkinci API deneyin
                        fetchYouTubeInfoAlternative(videoId)
                            .then(data => {
                                displayYouTubeInfoAlternative(data, videoId);
                            })
                            .catch(error => {
                                console.error('İkinci API hatası:', error);
                                showStatus('Video bilgisi alınamadı: ' + error.message, 'error');
                            })
                            .finally(() => {
                                document.getElementById('spinner').style.display = 'none';
                                document.getElementById('yt-analyze-btn').disabled = false;
                            });
                    })
                    .finally(() => {
                        document.getElementById('spinner').style.display = 'none';
                        document.getElementById('yt-analyze-btn').disabled = false;
                    });
            }
            
            function fetchYouTubeInfo(videoId) {
                const proxyUrl = getProxyUrl(`https://pipedapi.kavin.rocks/streams/${videoId}`);
                
                return fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Video bilgisi alınamadı');
                        }
                        return response.json();
                    });
            }
            
            function fetchYouTubeInfoAlternative(videoId) {
                const proxyUrl = getProxyUrl(`https://inv.vern.cc/api/v1/videos/${videoId}`);
                
                return fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Video bilgisi alınamadı');
                        }
                        return response.json();
                    });
            }
            
            function displayYouTubeInfo(data, videoId) {
                const thumbnailUrl = data.thumbnailUrl || `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`;
                const title = data.title || 'YouTube Video';
                const author = data.uploader || 'YouTube';
                const duration = formatDuration(data.duration);
                
                document.getElementById('thumbnail').src = thumbnailUrl;
                document.getElementById('video-title').textContent = title;
                document.getElementById('video-meta').textContent = `${author} | ${duration}`;
                
                // İndirme seçeneklerini görüntüle
                displayYouTubeDownloadOptions(data, videoId, title);
                
                document.getElementById('video-info-container').classList.remove('hidden');
                showStatus('Video analizi tamamlandı. İndirme seçeneklerini kullanabilirsiniz.', 'success');
            }
            
            function displayYouTubeInfoAlternative(data, videoId) {
                const thumbnailUrl = data.thumbnailUrl || `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`;
                const title = data.title || 'YouTube Video';
                const author = data.uploader?.name || 'YouTube';
                const duration = formatDuration(data.duration);
                
                document.getElementById('thumbnail').src = thumbnailUrl;
                document.getElementById('video-title').textContent = title;
                document.getElementById('video-meta').textContent = `${author} | ${duration}`;
                
                // İndirme seçeneklerini görüntüle
                displayYouTubeDownloadOptionsAlternative(data, videoId, title);
                
                document.getElementById('video-info-container').classList.remove('hidden');
                showStatus('Video analizi tamamlandı. İndirme seçeneklerini kullanabilirsiniz.', 'success');
            }
            
            function displayYouTubeDownloadOptions(data, videoId, title) {
                const qualityOptions = document.getElementById('quality-options');
                qualityOptions.innerHTML = '';
                
                // Video akışları
                const videoStreams = data.videoStreams || [];
                const audioStreams = data.audioStreams || [];
                
                if (videoStreams.length > 0 || audioStreams.length > 0) {
                    // Yüksek kalite video
                    const highQualityStreams = videoStreams.filter(stream => stream.height >= 1080);
                    if (highQualityStreams.length > 0) {
                        const stream = highQualityStreams[0];
                        addQualityOption(
                            qualityOptions, 
                            `${stream.height}p (Yüksek Kalite)`, 
                            `Video | ${Math.round(stream.bitrate/1000)} Kbps`, 
                            stream.url, 
                            title, 
                            'mp4'
                        );
                    }
                    
                    // 720p video
                    const mediumQualityStreams = videoStreams.filter(stream => stream.height >= 720 && stream.height < 1080);
                    if (mediumQualityStreams.length > 0) {
                        const stream = mediumQualityStreams[0];
                        addQualityOption(
                            qualityOptions, 
                            `${stream.height}p (Orta Kalite)`, 
                            `Video | ${Math.round(stream.bitrate/1000)} Kbps`, 
                            stream.url, 
                            title, 
                            'mp4'
                        );
                    }
                    
                    // Düşük kalite video
                    const lowQualityStreams = videoStreams.filter(stream => stream.height < 720);
                    if (lowQualityStreams.length > 0) {
                        const stream = lowQualityStreams[0];
                        addQualityOption(
                            qualityOptions, 
                            `${stream.height}p (Düşük Kalite)`, 
                            `Video | ${Math.round(stream.bitrate/1000)} Kbps`, 
                            stream.url, 
                            title, 
                            'mp4'
                        );
                    }
                    
                    // Sadece ses
                    if (audioStreams.length > 0) {
                        const stream = audioStreams.sort((a, b) => b.bitrate - a.bitrate)[0];
                        addQualityOption(
                            qualityOptions, 
                            `Sadece Ses (MP3)`, 
                            `Ses | ${Math.round(stream.bitrate/1000)} Kbps`, 
                            stream.url, 
                            title, 
                            'mp3'
                        );
                    }
                } else {
                    // API'den indirilebilir URL gelmezse, YT-Download API'sini kullanalım
                    addQualityOption(
                        qualityOptions, 
                        `1080p (Yüksek Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=137`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `720p (Orta Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=22`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `480p (Düşük Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=18`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `Sadece Ses (MP3)`, 
                        `Ses | MP3`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=bestaudio`, 
                        title, 
                        'mp3'
                    );
                }
            }
            
            function displayYouTubeDownloadOptionsAlternative(data, videoId, title) {
                const qualityOptions = document.getElementById('quality-options');
                qualityOptions.innerHTML = '';
                
                // İnviShare formatını kullan
                const formats = data.formatStreams || [];
                const adaptiveFormats = data.adaptiveFormats || [];
                
                if (formats.length > 0 || adaptiveFormats.length > 0) {
                    // Normal formatlar
                    formats.forEach(format => {
                        const resolution = format.resolution || format.qualityLabel || "Standart Kalite";
                        addQualityOption(
                            qualityOptions, 
                            resolution, 
                            `Video+Ses | ${format.container || 'mp4'}`, 
                            format.url, 
                            title, 
                            format.container || 'mp4'
                        );
                    });
                    
                    // Adaptif formatlar - Video
                    const videoFormats = adaptiveFormats.filter(format => format.type?.startsWith('video/'));
                    const highQualityVideo = videoFormats.sort((a, b) => {
                        const heightA = parseInt(a.resolution?.split('p')[0] || 0);
                        const heightB = parseInt(b.resolution?.split('p')[0] || 0);
                        return heightB - heightA;
                    }).slice(0, 2); // Sadece en yüksek 2 kalite
                    
                    highQualityVideo.forEach(format => {
                        const resolution = format.resolution || format.qualityLabel || "Video";
                        addQualityOption(
                            qualityOptions, 
                            `${resolution} (Sadece Video)`, 
                            `Video | ${format.container || 'mp4'}`, 
                            format.url, 
                            title, 
                            format.container || 'mp4'
                        );
                    });
                    
                    // Adaptif formatlar - Ses
                    const audioFormats = adaptiveFormats.filter(format => format.type?.startsWith('audio/'));
                    const bestAudio = audioFormats.sort((a, b) => b.bitrate - a.bitrate)[0];
                    
                    if (bestAudio) {
                        addQualityOption(
                            qualityOptions, 
                            `Sadece Ses (${bestAudio.audioQuality || 'Yüksek Kalite'})`, 
                            `Ses | ${Math.round((bestAudio.bitrate || 0)/1000)} Kbps`, 
                            bestAudio.url, 
                            title, 
                            'mp3'
                        );
                    }
                } else {
                    // API'den indirilebilir URL gelmezse, alternatif yöntemler gösterelim
                    addQualityOption(
                        qualityOptions, 
                        `1080p (Yüksek Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=137`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `720p (Orta Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=22`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `480p (Düşük Kalite)`, 
                        `Video | MP4`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=18`, 
                        title, 
                        'mp4'
                    );
                    
                    addQualityOption(
                        qualityOptions, 
                        `Sadece Ses (MP3)`, 
                        `Ses | MP3`, 
                        `https://projectlounge.pw/ytdl/download?url=https://www.youtube.com/watch?v=${videoId}&format=bestaudio`, 
                        title, 
                        'mp3'
                    );
                }
            }
            
            // Vimeo video analiz ve indirme işlevleri
            function analyzeVimeoVideo() {
                const videoUrl = document.getElementById('vimeo-url').value.trim();
                if (!videoUrl) {
                    document.getElementById('vimeo-status').textContent = 'Lütfen bir Vimeo URL\'si girin';
                    document.getElementById('vimeo-status').className = 'error';
                    document.getElementById('vimeo-status').classList.remove('hidden');
                    return;
                }
                
                const videoId = extractVimeoId(videoUrl);
                if (!videoId) {
                    document.getElementById('vimeo-status').textContent = 'Geçersiz Vimeo URL\'si';
                    document.getElementById('vimeo-status').className = 'error';
                    document.getElementById('vimeo-status').classList.remove('hidden');
                    return;
                }
                
                // UI sıfırlama ve yükleme gösterme
                document.getElementById('vimeo-status').textContent = 'Video analiz ediliyor...';
                document.getElementById('vimeo-status').className = 'info';
                document.getElementById('vimeo-status').classList.remove('hidden');
                document.getElementById('vimeo-spinner').style.display = 'block';
                document.getElementById('vimeo-info-container').classList.add('hidden');
                document.getElementById('vimeo-analyze-btn').disabled = true;
                
                // Vimeo bilgilerini çekme
                fetchVimeoInfo(videoId)
                    .then(data => {
                        displayVimeoInfo(data);
                    })
                    .catch(error => {
                        console.error('Vimeo API hatası:', error);
                        document.getElementById('vimeo-status').textContent = 'Video bilgisi alınamadı: ' + error.message;
                        document.getElementById('vimeo-status').className = 'error';
                    })
                    .finally(() => {
                        document.getElementById('vimeo-spinner').style.display = 'none';
                        document.getElementById('vimeo-analyze-btn').disabled = false;
                    });
            }
            
            function fetchVimeoInfo(videoId) {
                const proxyUrl = getProxyUrl(`https://player.vimeo.com/video/${videoId}/config`);
                
                return fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Vimeo video bilgisi alınamadı');
                        }
                        return response.json();
                    });
            }
            
            function displayVimeoInfo(data) {
                const videoData = data.video || {};
                const title = videoData.title || 'Vimeo Video';
                const thumbnailUrl = data.video?.thumbs?.base || 
                                    data.video?.thumbs?.[640] || 
                                    'https://i.vimeocdn.com/video/default.jpg';
                                    
                const owner = data.video?.owner?.name || 'Vimeo';
                const duration = formatDuration(videoData.duration);
                
                document.getElementById('vimeo-thumbnail').src = thumbnailUrl;
                document.getElementById('vimeo-title').textContent = title;
                document.getElementById('vimeo-meta').textContent = `${owner} | ${duration}`;
                
                // İndirme seçeneklerini görüntüle
                displayVimeoDownloadOptions(data, title);
                
                document.getElementById('vimeo-info-container').classList.remove('hidden');
                document.getElementById('vimeo-status').textContent = 'Video analizi tamamlandı. İndirme seçeneklerini kullanabilirsiniz.';
                document.getElementById('vimeo-status').className = 'success';
            }
            
            function displayVimeoDownloadOptions(data, title) {
                const qualityOptions = document.getElementById('vimeo-quality-options');
                qualityOptions.innerHTML = '';
                
                const files = data.request?.files?.progressive || [];
                
                if (files.length > 0) {
                    // Kaliteye göre sırala (yüksekten düşüğe)
                    files.sort((a, b) => b.height - a.height);
                    
                    // Her kaliteyi listele
                    files.forEach(file => {
                        addQualityOption(
                            qualityOptions,
                            `${file.height}p (${file.quality})`,
                            `Video | ${Math.round(file.size / 1024 / 1024)} MB`,
                            file.url,
                            title,
                            'mp4'
                        );
                    });
                } else {
                    // İndirilebilir URL bulunamadı
                    document.getElementById('vimeo-status').textContent = 'İndirilebilir video bulunamadı. Vimeo bazı videolar için indirme engeli koymuş olabilir.';
                    document.getElementById('vimeo-status').className = 'warning';
                }
            }
            
            // Ortak işlevler
            function extractVimeoId(url) {
                const regExp = /(?:www\.|player\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:[a-zA-Z0-9_\-]+)?/i;
                const match = url.match(regExp);
                return match ? match[1] : null;
            }
            
            function extractYouTubeId(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }
            
            function formatDuration(seconds) {
                if (!seconds) return 'Bilinmeyen süre';
                
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                let result = '';
                
                if (hrs > 0) {
                    result += `${hrs}:`;
                    result += `${mins.toString().padStart(2, '0')}:`;
                } else {
                    result += `${mins}:`;
                }
                
                result += secs.toString().padStart(2, '0');
                
                return result;
            }
            
            function getProxyUrl(url) {
                const proxyServer = localStorage.getItem('proxyServer') || 'corsanywhere';
                
                switch(proxyServer) {
                    case 'corsanywhere':
                        return `https://cors-anywhere.herokuapp.com/${url}`;
                    case 'allorigins':
                        return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    case 'none':
                    default:
                        return url;
                }
            }
            
            function addQualityOption(container, qualityName, qualityDesc, downloadUrl, title, format) {
                const div = document.createElement('div');
                div.className = 'quality-option';
                
                const h3 = document.createElement('h3');
                h3.textContent = qualityName;
                div.appendChild(h3);
                
                const p = document.createElement('p');
                p.textContent = qualityDesc;
                div.appendChild(p);
                
                // İndirme yöntemine göre işlem yap
                const downloadMethod = localStorage.getItem('downloadMethod') || 'direct';
                
                if (downloadMethod === 'direct') {
                    // Doğrudan indirme bağlantısı
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.className = 'download-btn';
                    a.textContent = 'İndir';
                    a.setAttribute('download', generateFilename(title, qualityName, format));
                    a.addEventListener('click', function(e) {
                        e.preventDefault();
                        directDownload(downloadUrl, generateFilename(title, qualityName, format));
                    });
                    div.appendChild(a);
                } else {
                    // Blob indirme butonu
                    const button = document.createElement('button');
                    button.className = 'download-btn';
                    button.textContent = 'İndir';
                    button.addEventListener('click', function() {
                        blobDownload(downloadUrl, generateFilename(title, qualityName, format));
                    });
                    div.appendChild(button);
                }
                
                container.appendChild(div);
            }
            
            function generateFilename(title, quality, format) {
                const template = localStorage.getItem('filenameTemplate') || '{title}';
                const date = new Date().toISOString().slice(0, 10);
                
                // Geçersiz karakterleri temizle
                title = title.replace(/[\\/:*?"<>|]/g, '_');
                
                // Şablonu uygula
                return template
                    .replace('{title}', title)
                    .replace('{quality}', quality)
                    .replace('{date}', date) + '.' + format;
            }
            
            function directDownload(url, filename) {
                // Doğrudan indirme bağlantısını kullan
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                }, 100);
                
                showStatus('İndirme başlatıldı. Dosya adı: ' + filename, 'success');
            }
            
            function blobDownload(url, filename) {
                // İlerleme göstergesini göster
                document.getElementById('progress-container').style.display = 'block';
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('progress-text').textContent = '0%';
                
                // URL'yi fetch ile al ve ilerlemeyi izle
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('İndirme başlatılamadı');
                        
                        // Toplam boyut
                        const totalSize = parseInt(response.headers.get('content-length') || '0');
                        let downloaded = 0;
                        
                        // İlerleme izleyici ile yanıtı okuma
                        const reader = response.body.getReader();
                        const chunks = [];
                        
                        // İlerlemeyi izle ve chunk'ları topla
                        return new Promise((resolve, reject) => {
                            function readChunk() {
                                reader.read().then(({ done, value }) => {
                                    if (done) {
                                        resolve(chunks);
                                        return;
                                    }
                                    
                                    chunks.push(value);
                                    downloaded += value.length;
                                    
                                    // İlerleme güncellemesi
                                    const progress = totalSize ? Math.round((downloaded / totalSize) * 100) : 0;
                                    document.getElementById('progress-fill').style.width = progress + '%';
                                    document.getElementById('progress-text').textContent = progress + '%';
                                    
                                    readChunk();
                                }).catch(reject);
                            }
                            
                            readChunk();
                        });
                    })
                    .then(chunks => {
                        // Chunk'ları birleştir
                        const blob = new Blob(chunks);
                        
                        // Dosya indirme bağlantısını oluştur
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Bağlantıyı temizle
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        showStatus('İndirme tamamlandı! Dosya adı: ' + filename, 'success');
                    })
                    .catch(error => {
                        console.error('İndirme hatası:', error);
                        showStatus('İndirme başarısız oldu: ' + error.message, 'error');
                    })
                    .finally(() => {
                        // İlerlemeyi gizle
                        setTimeout(() => {
                            document.getElementById('progress-container').style.display = 'none';
                        }, 2000);
                    });
            }
            
            // Ayarlar işlevleri
            function loadSettings() {
                const downloadMethod = localStorage.getItem('downloadMethod') || 'direct';
                const proxyServer = localStorage.getItem('proxyServer') || 'corsanywhere';
                const filenameTemplate = localStorage.getItem('filenameTemplate') || '{title}';
                
                document.getElementById('download-method').value = downloadMethod;
                document.getElementById('proxy-server').value = proxyServer;
                document.getElementById('filename-template').value = filenameTemplate;
            }
            
            function saveSettings() {
                const downloadMethod = document.getElementById('download-method').value;
                const proxyServer = document.getElementById('proxy-server').value;
                const filenameTemplate = document.getElementById('filename-template').value;
                
                localStorage.setItem('downloadMethod', downloadMethod);
                localStorage.setItem('proxyServer', proxyServer);
                localStorage.setItem('filenameTemplate', filenameTemplate);
            }
            
            function showStatus(message, type) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = type;
                statusElement.classList.remove('hidden');
                
                // Otomatik gizle
                setTimeout(() => {
                    statusElement.classList.add('fade-out');
                    setTimeout(() => {
                        if (statusElement.classList.contains('fade-out')) {
                            statusElement.classList.add('hidden');
                            statusElement.classList.remove('fade-out');
                        }
                    }, 500);
                }, 5000);
            }
        });
    </script>
</body>
</html>
